---
// Simple client-side filtering using vanilla JS, no React
const { items } = Astro.props
---

<div id="htb-filters" class="mb-6 space-y-4">
  <div class="flex flex-wrap gap-3 items-center">
    <span class="text-sm font-medium">Filter by:</span>
    
    <select id="category-filter" class="rounded-md border border-input bg-background px-3 py-2 text-sm">
      <option value="all">All Categories</option>
      <option value="Forensics">Forensics</option>
      <option value="Web">Web</option>
      <option value="Pwn">Pwn</option>
      <option value="Crypto">Crypto</option>
      <option value="Reversing">Reversing</option>
      <option value="Misc">Misc</option>
      <option value="Hardware">Hardware</option>
      <option value="Mobile">Mobile</option>
      <option value="OSINT">OSINT</option>
    </select>

    <select id="difficulty-filter" class="rounded-md border border-input bg-background px-3 py-2 text-sm">
      <option value="all">All Difficulties</option>
      <option value="Very Easy">Very Easy</option>
      <option value="Easy">Easy</option>
      <option value="Medium">Medium</option>
      <option value="Hard">Hard</option>
      <option value="Insane">Insane</option>
    </select>

    <select id="sort-by" class="rounded-md border border-input bg-background px-3 py-2 text-sm ml-auto">
      <option value="date-desc">Newest First</option>
      <option value="date-asc">Oldest First</option>
      <option value="title-asc">Title A-Z</option>
      <option value="title-desc">Title Z-A</option>
    </select>
  </div>

  <div id="results-count" class="text-sm text-muted-foreground"></div>
</div>

<script is:inline>
  function setupHTBFilters() {
    const categoryFilter = document.getElementById('category-filter')
    const difficultyFilter = document.getElementById('difficulty-filter')
    const sortBy = document.getElementById('sort-by')
    const resultsCount = document.getElementById('results-count')

    if (!categoryFilter || !difficultyFilter || !sortBy) {
      return
    }

    function updateDisplay() {
      const cards = Array.from(document.querySelectorAll('[data-htb-card]'))
      const categoryValue = categoryFilter.value
      const difficultyValue = difficultyFilter.value
      const sortValue = sortBy.value

      // Filter cards
      let visibleCards = cards.filter(card => {
        const el = card
        const category = el.dataset.category
        const difficulty = el.dataset.difficulty

        const categoryMatch = categoryValue === 'all' || category === categoryValue
        const difficultyMatch = difficultyValue === 'all' || difficulty === difficultyValue

        return categoryMatch && difficultyMatch
      })

      // Sort cards
      visibleCards.sort((a, b) => {
        const elA = a
        const elB = b

        switch (sortValue) {
          case 'date-desc':
            return new Date(elB.dataset.date || '').getTime() - new Date(elA.dataset.date || '').getTime()
          case 'date-asc':
            return new Date(elA.dataset.date || '').getTime() - new Date(elB.dataset.date || '').getTime()
          case 'title-asc':
            return (elA.dataset.title || '').localeCompare(elB.dataset.title || '')
          case 'title-desc':
            return (elB.dataset.title || '').localeCompare(elA.dataset.title || '')
          default:
            return 0
        }
      })

      // Hide all cards first
      cards.forEach(card => {
        card.style.display = 'none'
      })

      // Show and reorder visible cards
      const container = cards[0]?.parentElement
      if (container) {
        visibleCards.forEach(card => {
          card.style.display = 'block'
          container.appendChild(card)
        })
      }

      // Update count
      if (resultsCount) {
        resultsCount.textContent = `Showing ${visibleCards.length} of ${cards.length} ${visibleCards.length === 1 ? 'item' : 'items'}`
      }
    }

    // Remove old listeners if they exist
    const newCategoryFilter = categoryFilter.cloneNode(true)
    const newDifficultyFilter = difficultyFilter.cloneNode(true)
    const newSortBy = sortBy.cloneNode(true)
    
    categoryFilter.parentNode.replaceChild(newCategoryFilter, categoryFilter)
    difficultyFilter.parentNode.replaceChild(newDifficultyFilter, difficultyFilter)
    sortBy.parentNode.replaceChild(newSortBy, sortBy)

    // Add event listeners to new elements
    newCategoryFilter.addEventListener('change', updateDisplay)
    newDifficultyFilter.addEventListener('change', updateDisplay)
    newSortBy.addEventListener('change', updateDisplay)

    // Initial display
    updateDisplay()
  }

  // Run on initial page load
  setupHTBFilters()

  // Run after Astro page transitions
  document.addEventListener('astro:page-load', setupHTBFilters)
</script>
